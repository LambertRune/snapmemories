<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Download je Snapchat Memories veilig en priv√©. 100% client-side - geen data wordt opgeslagen op onze servers.">
    <title>SnapMemories Downloader | Phiosk</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üì∏</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        :root {
            --sage: #8fb584;
            --sage-dark: #6d9462;
            --sage-light: #c5e0bc;
            --cream: #fdfbf7;
            --cream-dark: #f5f2eb;
            --text: #1a2e1a;
            --text-light: #5a6c5a;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--cream);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.6;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: -20%; right: -10%;
            width: 60%; height: 60%;
            background: radial-gradient(circle, rgba(100,149,237,0.12) 0%, transparent 70%);
            pointer-events: none;
        }
        
        body::after {
            content: '';
            position: fixed;
            bottom: -20%; left: -10%;
            width: 50%; height: 50%;
            background: radial-gradient(circle, rgba(143,181,132,0.15) 0%, transparent 70%);
            pointer-events: none;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 24px;
            position: relative;
            z-index: 1;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .badge {
            display: inline-block;
            background: var(--sage-light);
            color: var(--sage-dark);
            padding: 6px 16px;
            border-radius: 100px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }
        
        h1 {
            font-family: 'Playfair Display', Georgia, serif;
            font-size: 2.8rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 12px;
        }
        
        .subtitle {
            color: var(--text-light);
            font-size: 1.05rem;
            max-width: 500px;
            margin: 0 auto;
        }
        
        .card {
            background: white;
            border-radius: 16px;
            padding: 28px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.04);
            border: 1px solid rgba(0,0,0,0.04);
        }
        
        .card-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .step-num {
            width: 28px; height: 28px;
            background: var(--sage);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            font-weight: 600;
        }
        
        textarea {
            display: none;
        }
        
        .dropzone {
            width: 100%;
            min-height: 160px;
            border: 3px dashed var(--cream-dark);
            border-radius: 12px;
            background: var(--cream);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 30px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .dropzone:hover, .dropzone.dragover {
            border-color: var(--sage);
            background: var(--sage-light);
        }
        
        .dropzone.has-file {
            border-color: var(--sage);
            background: linear-gradient(135deg, var(--sage-light), var(--cream));
        }
        
        .dropzone-icon {
            font-size: 48px;
            line-height: 1;
        }
        
        .dropzone-text {
            font-size: 14px;
            color: var(--text-light);
            text-align: center;
        }
        
        .dropzone-text strong {
            color: var(--sage-dark);
        }
        
        .dropzone-filename {
            font-family: 'Monaco', monospace;
            font-size: 13px;
            color: var(--sage-dark);
            background: white;
            padding: 8px 16px;
            border-radius: 100px;
            margin-top: 8px;
        }
        
        .how-to-card {
            background: linear-gradient(135deg, #e8f5e9, var(--cream));
            border: 1px solid var(--sage-light);
        }
        
        .how-to-steps {
            display: grid;
            gap: 16px;
            margin-top: 16px;
        }
        
        .how-to-step {
            display: flex;
            gap: 14px;
            align-items: flex-start;
        }
        
        .how-to-num {
            width: 26px;
            height: 26px;
            background: var(--sage);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            flex-shrink: 0;
        }
        
        .how-to-content h4 {
            font-size: 14px;
            margin-bottom: 4px;
            color: var(--text);
        }
        
        .how-to-content p {
            font-size: 13px;
            color: var(--text-light);
            margin: 0;
        }
        
        .how-to-content a {
            color: var(--sage-dark);
        }
        
        textarea:focus {
            outline: none;
            border-color: var(--sage);
            box-shadow: 0 0 0 3px var(--sage-light);
        }
        
        .btn-row {
            display: flex;
            gap: 10px;
            margin-top: 16px;
            flex-wrap: wrap;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            border-radius: 100px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }
        
        .btn-primary {
            background: var(--sage);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: var(--sage-dark);
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(143,181,132,0.35);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-outline {
            background: transparent;
            color: var(--text);
            border: 2px solid var(--cream-dark);
        }
        
        .btn-outline:hover {
            border-color: var(--sage);
            color: var(--sage-dark);
        }
        
        .btn-danger {
            background: #e57373;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c62828;
        }
        
        .btn-warning {
            background: #ffb74d;
            color: #333;
        }
        
        .btn-warning:hover {
            background: #f57c00;
        }
        
        /* Privacy Section */
        .privacy-box {
            background: linear-gradient(135deg, var(--sage-light), var(--cream));
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .privacy-box h4 {
            font-family: 'Playfair Display', serif;
            font-size: 1rem;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .privacy-list {
            list-style: none;
            font-size: 13px;
            color: var(--text-light);
        }
        
        .privacy-list li {
            padding: 4px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .privacy-list li::before {
            content: '‚úì';
            color: var(--sage-dark);
            font-weight: bold;
        }
        
        /* Progress */
        .progress-section { display: none; }
        .progress-section.active { display: block; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin: 20px 0;
        }
        
        .stat-box {
            text-align: center;
            padding: 14px 8px;
            background: var(--cream);
            border-radius: 10px;
        }
        
        .stat-value {
            font-family: 'Playfair Display', serif;
            font-size: 1.6rem;
            font-weight: 600;
            color: var(--sage-dark);
        }
        
        .stat-label {
            font-size: 11px;
            color: var(--text-light);
            margin-top: 2px;
            text-transform: uppercase;
        }
        
        .progress-bar {
            height: 10px;
            background: var(--cream-dark);
            border-radius: 100px;
            overflow: hidden;
            margin: 16px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--sage), var(--sage-dark));
            border-radius: 100px;
            transition: width 0.3s;
            width: 0%;
        }
        
        .progress-info {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: var(--text-light);
        }
        
        .speed-row {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin: 20px 0;
            padding: 16px;
            background: var(--cream);
            border-radius: 10px;
        }
        
        .speed-item { text-align: center; }
        
        .speed-label {
            font-size: 10px;
            color: var(--text-light);
            text-transform: uppercase;
            margin-bottom: 2px;
        }
        
        .speed-value {
            font-family: 'Playfair Display', serif;
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--sage-dark);
        }
        
        .status-badge {
            padding: 5px 12px;
            border-radius: 100px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            margin-left: auto;
        }
        
        .status-idle { background: var(--cream-dark); color: var(--text-light); }
        .status-parsing { background: #e3f2fd; color: #1976d2; }
        .status-downloading { background: var(--sage-light); color: var(--sage-dark); }
        .status-zipping { background: #fff3e0; color: #f57c00; }
        .status-done { background: var(--sage-light); color: var(--sage-dark); }
        .status-error { background: #ffebee; color: #c62828; }
        
        .result-box {
            display: none;
            text-align: center;
            padding: 28px;
            background: linear-gradient(135deg, var(--sage-light), var(--cream));
            border-radius: 14px;
            margin-top: 20px;
        }
        
        .result-box.active { display: block; }
        
        .result-box h3 {
            font-family: 'Playfair Display', serif;
            font-size: 1.4rem;
            color: var(--sage-dark);
            margin-bottom: 10px;
        }
        
        .footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: var(--text-light);
            font-size: 13px;
        }
        
        .footer a {
            color: var(--sage-dark);
            text-decoration: none;
        }
        
        .gdpr-section {
            margin-top: 40px;
            padding: 24px;
            background: white;
            border-radius: 16px;
            border: 1px solid rgba(0,0,0,0.04);
        }
        
        .gdpr-section h3 {
            font-family: 'Playfair Display', serif;
            font-size: 1.2rem;
            margin-bottom: 16px;
        }
        
        .gdpr-section p {
            font-size: 13px;
            color: var(--text-light);
            margin-bottom: 12px;
        }
        
        .gdpr-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }
        
        .gdpr-item {
            padding: 16px;
            background: var(--cream);
            border-radius: 10px;
        }
        
        .gdpr-item h4 {
            font-size: 14px;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .gdpr-item p {
            font-size: 12px;
            margin: 0;
        }
        
        @media (max-width: 600px) {
            h1 { font-size: 2rem; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .speed-row { gap: 20px; }
            .gdpr-grid { grid-template-columns: 1fr; }
        }
        
        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-overlay.active { display: flex; }
        
        .modal {
            background: white;
            border-radius: 16px;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 32px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .modal h2 {
            font-family: 'Playfair Display', serif;
            font-size: 1.6rem;
            margin-bottom: 20px;
            color: var(--sage-dark);
        }
        
        .modal h3 {
            font-size: 1rem;
            margin: 20px 0 10px;
            color: var(--text);
        }
        
        .modal p, .modal li {
            font-size: 13px;
            color: var(--text-light);
            line-height: 1.7;
            margin-bottom: 10px;
        }
        
        .modal ul { padding-left: 20px; }
        
        .modal-close {
            display: block;
            margin: 24px auto 0;
            padding: 12px 32px;
        }
        
        /* Disclaimer Checkbox */
        .disclaimer-box {
            background: #fff3e0;
            border: 2px solid #ffb74d;
            border-radius: 10px;
            padding: 16px;
            margin-top: 20px;
        }
        
        .disclaimer-box label {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            cursor: pointer;
            font-size: 13px;
            color: var(--text);
        }
        
        .disclaimer-box input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-top: 2px;
            accent-color: var(--sage);
        }
        
        .disclaimer-box a {
            color: var(--sage-dark);
            text-decoration: underline;
        }
        
        .legal-links {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(0,0,0,0.1);
        }
        
        .legal-links a {
            color: var(--sage-dark);
            text-decoration: none;
            margin: 0 10px;
            font-size: 12px;
        }
        
        .legal-links a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="badge">üîí 100% Privacy</div>
            <h1>SnapMemories</h1>
            <p class="subtitle">Download je Snapchat herinneringen veilig. Alles gebeurt in jouw browser - wij zien of bewaren niets.</p>
        </header>
        
        <!-- How to get your file -->
        <div class="card how-to-card">
            <div class="card-title">
                <span class="step-num">?</span>
                Hoe krijg je jouw memories_history.html?
            </div>
            
            <div class="how-to-steps">
                <div class="how-to-step">
                    <span class="how-to-num">1</span>
                    <div class="how-to-content">
                        <h4>Vraag je data aan bij Snapchat</h4>
                        <p>Ga naar <a href="https://accounts.snapchat.com/accounts/downloadmydata" target="_blank">accounts.snapchat.com/accounts/downloadmydata</a> en log in.</p>
                    </div>
                </div>
                <div class="how-to-step">
                    <span class="how-to-num">2</span>
                    <div class="how-to-content">
                        <h4>Selecteer "Export My Data"</h4>
                        <p>Klik op de knop en wacht tot je een e-mail ontvangt (dit kan 1-2 dagen duren).</p>
                    </div>
                </div>
                <div class="how-to-step">
                    <span class="how-to-num">3</span>
                    <div class="how-to-content">
                        <h4>Download en pak uit</h4>
                        <p>Download het ZIP-bestand uit de e-mail en pak het uit op je computer.</p>
                    </div>
                </div>
                <div class="how-to-step">
                    <span class="how-to-num">4</span>
                    <div class="how-to-content">
                        <h4>Zoek memories_history.html</h4>
                        <p>Open de map <code>html</code> ‚Üí zoek het bestand <code>memories_history.html</code></p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-title">
                <span class="step-num">1</span>
                Sleep je bestand hierheen
            </div>
            
            <div class="dropzone" id="dropzone" onclick="document.getElementById('fileInput').click()">
                <span class="dropzone-icon">üìÅ</span>
                <p class="dropzone-text">
                    <strong>Klik of sleep</strong> je memories_history.html hier
                </p>
            </div>
            <input type="file" id="fileInput" accept=".html" style="display:none" onchange="loadFile(event)">
            <textarea id="htmlInput" style="display:none"></textarea>
            
            <div class="btn-row">
                <button class="btn btn-primary" id="startBtn" onclick="startDownload()">
                    üöÄ Start Download
                </button>
            </div>
            
            <div class="disclaimer-box">
                <label>
                    <input type="checkbox" id="acceptTerms" onchange="toggleStartButton()">
                    <span>
                        Ik bevestig dat ik mijn <strong>eigen Snapchat data</strong> download, heb de 
                        <a href="#" onclick="openModal('tosModal'); return false;">Terms of Service</a> en 
                        <a href="#" onclick="openModal('privacyModal'); return false;">Privacy Policy</a> 
                        gelezen, en gebruik deze tool <strong>op eigen risico</strong>.
                    </span>
                </label>
            </div>
            
            <div class="privacy-box">
                <h4>üõ°Ô∏è Jouw Privacy is Gegarandeerd</h4>
                <ul class="privacy-list">
                    <li>Alle downloads gebeuren direct in jouw browser</li>
                    <li>Geen data wordt naar onze servers gestuurd</li>
                    <li>Wij kunnen je bestanden niet zien of opslaan</li>
                    <li>De HTML blijft 100% op jouw apparaat</li>
                </ul>
            </div>
        </div>
        
        <div class="card progress-section" id="progressCard">
            <div class="card-title">
                <span class="step-num">2</span>
                Voortgang
                <span class="status-badge status-idle" id="statusBadge">Gereed</span>
            </div>
            
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-value" id="totalStat">0</div>
                    <div class="stat-label">Totaal</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="completedStat">0</div>
                    <div class="stat-label">Voltooid</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="failedStat">0</div>
                    <div class="stat-label">Mislukt</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="sizeStat">0</div>
                    <div class="stat-label">MB</div>
                </div>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            
            <div class="progress-info">
                <span id="progressText">Wachten...</span>
                <span id="progressPct">0%</span>
            </div>
            
            <div class="speed-row">
                <div class="speed-item">
                    <div class="speed-label">Snelheid</div>
                    <div class="speed-value" id="speedValue">-- MB/s</div>
                </div>
                <div class="speed-item">
                    <div class="speed-label">Resterende tijd</div>
                    <div class="speed-value" id="etaValue">--:--</div>
                </div>
            </div>
            
            <div class="btn-row" id="controlBtns" style="display:none;justify-content:center;margin-top:16px">
                <button class="btn btn-warning" id="pauseBtn" onclick="togglePause()">
                    ‚è∏Ô∏è Pauzeren
                </button>
                <button class="btn btn-danger" id="stopBtn" onclick="stopDownload()">
                    ‚èπÔ∏è Stoppen
                </button>
            </div>
            
            <div class="result-box" id="resultBox">
                <h3>‚úÖ Download Voltooid!</h3>
                <p style="color:var(--text-light);margin-bottom:16px">Je ZIP bestand wordt nu gedownload</p>
                <button class="btn btn-primary" onclick="downloadZip()">üì¶ Download Opnieuw</button>
            </div>
        </div>
        
        <section class="gdpr-section">
            <h3>üá™üá∫ GDPR & Privacy Compliance</h3>
            <p>Deze tool is ontworpen met privacy als prioriteit. We voldoen volledig aan de Europese GDPR-wetgeving.</p>
            
            <div class="gdpr-grid">
                <div class="gdpr-item">
                    <h4>üñ•Ô∏è 100% Client-Side</h4>
                    <p>Alle verwerking gebeurt lokaal in jouw browser. Er wordt geen data naar servers gestuurd.</p>
                </div>
                <div class="gdpr-item">
                    <h4>üö´ Geen Opslag</h4>
                    <p>Wij slaan geen bestanden, cookies of persoonlijke gegevens op. Nul data retentie.</p>
                </div>
                <div class="gdpr-item">
                    <h4>üîí Direct Download</h4>
                    <p>Downloads gaan rechtstreeks van Snapchat naar jouw computer. Wij zijn slechts een interface.</p>
                </div>
                <div class="gdpr-item">
                    <h4>üìç Geen Tracking</h4>
                    <p>Geen analytics, geen cookies, geen fingerprinting. Jouw bezoek is volledig anoniem.</p>
                </div>
            </div>
        </section>
        
        <footer class="footer">
            <p>Gemaakt door <a href="https://development.phiosk.be" target="_blank">Phiosk Development</a></p>
            <p style="margin-top:8px;opacity:0.7;font-size:11px">
                ‚ö†Ô∏è Niet geaffilieerd met Snapchat Inc. ‚Ä¢ Onoffici√´le tool voor persoonlijk gebruik
            </p>
            <div class="legal-links">
                <a href="#" onclick="openModal('tosModal'); return false;">Terms of Service</a>
                <a href="#" onclick="openModal('privacyModal'); return false;">Privacy Policy</a>
            </div>
        </footer>
    </div>
    
    <script>
    // ========== PURE CLIENT-SIDE SNAPCHAT MEMORIES DOWNLOADER ==========
    // All processing happens in the browser - no server communication
    
    let memories = [];
    let zipFile = null;
    let stats = { total: 0, completed: 0, failed: 0, bytes: 0, startTime: 0 };
    let isPaused = false;
    let isStopped = false;
    let currentBatchIndex = 0;
    
    function loadFile(e) {
        const file = e.target.files[0];
        if (file) {
            handleFile(file);
        }
    }
    
    function handleFile(file) {
        const dropzone = document.getElementById('dropzone');
        const reader = new FileReader();
        reader.onload = (ev) => {
            document.getElementById('htmlInput').value = ev.target.result;
            dropzone.classList.add('has-file');
            dropzone.innerHTML = `
                <span class="dropzone-icon">‚úÖ</span>
                <p class="dropzone-text"><strong>Bestand geladen!</strong></p>
                <span class="dropzone-filename">${file.name}</span>
            `;
        };
        reader.readAsText(file);
    }
    
    // Drag & Drop handlers
    document.addEventListener('DOMContentLoaded', function() {
        const dropzone = document.getElementById('dropzone');
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropzone.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            dropzone.addEventListener(eventName, () => dropzone.classList.add('dragover'), false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropzone.addEventListener(eventName, () => dropzone.classList.remove('dragover'), false);
        });
        
        dropzone.addEventListener('drop', (e) => {
            const file = e.dataTransfer.files[0];
            if (file && file.name.endsWith('.html')) {
                handleFile(file);
            } else {
                alert('Selecteer een .html bestand');
            }
        }, false);
        
        // Initialize button state
        document.getElementById('startBtn').disabled = true;
    });
    
    function parseHTML(html) {
        const mems = [];
        const pattern = /downloadMemories\('([^']+)',\s*this,\s*(true|false)\)/g;
        const rowPattern = /<tr>([\s\S]*?)<\/tr>/g;
        
        let match;
        while ((match = rowPattern.exec(html)) !== null) {
            const row = match[1];
            
            const dateMatch = row.match(/<td>(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2} UTC)<\/td>/);
            const mediaMatch = row.match(/<td>(Video|Image)<\/td>/);
            const urlMatch = row.match(/downloadMemories\('([^']+)',\s*this,\s*(true|false)\)/);
            
            if (dateMatch && mediaMatch && urlMatch) {
                const date = new Date(dateMatch[1].replace(' UTC', 'Z'));
                const url = new URL(urlMatch[1]);
                const sid = url.searchParams.get('sid') || 'unknown';
                
                mems.push({
                    date: date,
                    media: mediaMatch[1].toLowerCase(),
                    url: urlMatch[1],
                    isGet: urlMatch[2] === 'true',
                    sid: sid.substring(0, 8),
                    filename: `${date.getFullYear()}${String(date.getMonth()+1).padStart(2,'0')}${String(date.getDate()).padStart(2,'0')}_${String(date.getHours()).padStart(2,'0')}${String(date.getMinutes()).padStart(2,'0')}${String(date.getSeconds()).padStart(2,'0')}_${sid.substring(0,8)}${mediaMatch[1].toLowerCase() === 'video' ? '.mp4' : '.jpg'}`,
                    folder: `${mediaMatch[1].toLowerCase() === 'video' ? 'videos' : 'images'}/${date.getFullYear()}/${String(date.getMonth()+1).padStart(2,'0')}`
                });
            }
        }
        
        return mems;
    }
    
    function updateStatus(status) {
        const badge = document.getElementById('statusBadge');
        badge.className = 'status-badge status-' + status;
        const labels = {
            idle: 'Gereed',
            parsing: 'Parsen...',
            downloading: 'Downloaden',
            paused: 'Gepauzeerd',
            zipping: 'ZIP maken',
            done: 'Voltooid',
            stopped: 'Gestopt',
            error: 'Fout'
        };
        badge.textContent = labels[status] || status;
    }
    
    function togglePause() {
        isPaused = !isPaused;
        const btn = document.getElementById('pauseBtn');
        if (isPaused) {
            btn.textContent = '‚ñ∂Ô∏è Hervatten';
            btn.className = 'btn btn-primary';
            updateStatus('paused');
        } else {
            btn.textContent = '‚è∏Ô∏è Pauzeren';
            btn.className = 'btn btn-warning';
            updateStatus('downloading');
        }
    }
    
    function stopDownload() {
        if (confirm('Weet je zeker dat je wilt stoppen? Je kunt wel de al gedownloade bestanden als ZIP downloaden.')) {
            isStopped = true;
            isPaused = false;
            updateStatus('stopped');
            document.getElementById('controlBtns').style.display = 'none';
            document.getElementById('resultBox').classList.add('active');
            document.getElementById('startBtn').disabled = false;
        }
    }
    
    async function waitWhilePaused() {
        while (isPaused && !isStopped) {
            await new Promise(r => setTimeout(r, 100));
        }
    }
    
    function updateProgress() {
        const pct = stats.total > 0 ? Math.round((stats.completed + stats.failed) / stats.total * 100) : 0;
        document.getElementById('progressFill').style.width = pct + '%';
        document.getElementById('progressPct').textContent = pct + '%';
        document.getElementById('totalStat').textContent = stats.total;
        document.getElementById('completedStat').textContent = stats.completed;
        document.getElementById('failedStat').textContent = stats.failed;
        document.getElementById('sizeStat').textContent = (stats.bytes / 1048576).toFixed(1);
        
        const elapsed = (Date.now() - stats.startTime) / 1000;
        const speed = elapsed > 0 ? stats.bytes / elapsed : 0;
        document.getElementById('speedValue').textContent = (speed / 1048576).toFixed(2) + ' MB/s';
        
        const remaining = stats.total - stats.completed - stats.failed;
        if (stats.completed > 0) {
            const avgTime = elapsed / stats.completed;
            const eta = remaining * avgTime;
            const mins = Math.floor(eta / 60);
            const secs = Math.floor(eta % 60);
            document.getElementById('etaValue').textContent = `${mins}m ${secs}s`;
        }
        
        document.getElementById('progressText').textContent = `${stats.completed + stats.failed} van ${stats.total} verwerkt`;
    }
    
    async function downloadMemory(mem) {
        try {
            const headers = {
                'X-Snap-Route-Tag': 'mem-dmd'
            };
            
            let response;
            if (mem.isGet) {
                response = await fetch(mem.url, { headers, mode: 'cors' });
            } else {
                const [baseUrl, params] = mem.url.split('?');
                response = await fetch(baseUrl, {
                    method: 'POST',
                    headers: { ...headers, 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: params,
                    mode: 'cors'
                });
            }
            
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            const contentType = response.headers.get('Content-Type') || '';
            
            if (contentType.includes('text')) {
                const redirectUrl = await response.text();
                if (redirectUrl.startsWith('http')) {
                    response = await fetch(redirectUrl, { mode: 'cors' });
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                }
            }
            
            const blob = await response.blob();
            stats.bytes += blob.size;
            stats.completed++;
            
            return { success: true, blob, mem };
        } catch (e) {
            stats.failed++;
            return { success: false, error: e.message, mem };
        }
    }
    
    async function startDownload() {
        const html = document.getElementById('htmlInput').value;
        if (!html.trim()) {
            alert('Plak eerst de HTML inhoud!');
            return;
        }
        
        document.getElementById('startBtn').disabled = true;
        document.getElementById('progressCard').classList.add('active');
        updateStatus('parsing');
        
        // Parse HTML
        memories = parseHTML(html);
        
        if (memories.length === 0) {
            alert('Geen herinneringen gevonden in de HTML. Controleer of je het juiste bestand hebt geplakt.');
            document.getElementById('startBtn').disabled = false;
            updateStatus('error');
            return;
        }
        
        // Initialize stats
        stats = { total: memories.length, completed: 0, failed: 0, bytes: 0, startTime: Date.now() };
        isPaused = false;
        isStopped = false;
        updateProgress();
        updateStatus('downloading');
        
        // Show control buttons
        document.getElementById('controlBtns').style.display = 'flex';
        document.getElementById('pauseBtn').textContent = '‚è∏Ô∏è Pauzeren';
        document.getElementById('pauseBtn').className = 'btn btn-warning';
        
        // Create ZIP
        zipFile = new JSZip();
        
        // Download in batches of 5 (browser friendly)
        const batchSize = 5;
        for (let i = 0; i < memories.length && !isStopped; i += batchSize) {
            await waitWhilePaused();
            if (isStopped) break;
            
            const batch = memories.slice(i, i + batchSize);
            const results = await Promise.all(batch.map(downloadMemory));
            
            for (const result of results) {
                if (result.success) {
                    zipFile.file(`${result.mem.folder}/${result.mem.filename}`, result.blob);
                }
            }
            
            updateProgress();
        }
        
        // Hide control buttons
        document.getElementById('controlBtns').style.display = 'none';
        
        // Generate ZIP
        updateStatus('zipping');
        document.getElementById('progressText').textContent = 'ZIP bestand genereren...';
        
        try {
            const content = await zipFile.generateAsync({ 
                type: 'blob',
                compression: 'DEFLATE',
                compressionOptions: { level: 6 }
            }, (meta) => {
                document.getElementById('progressText').textContent = `ZIP: ${meta.percent.toFixed(0)}%`;
            });
            
            // Save file
            saveAs(content, 'snapchat_memories.zip');
            
            updateStatus('done');
            document.getElementById('resultBox').classList.add('active');
        } catch (e) {
            updateStatus('error');
            alert('Fout bij maken ZIP: ' + e.message);
        }
        
        document.getElementById('startBtn').disabled = false;
    }
    
    async function downloadZip() {
        if (zipFile) {
            const content = await zipFile.generateAsync({ type: 'blob' });
            saveAs(content, 'snapchat_memories.zip');
        }
    }
    
    // Modal functions
    function openModal(id) {
        document.getElementById(id).classList.add('active');
        document.body.style.overflow = 'hidden';
    }
    
    function closeModal(id) {
        document.getElementById(id).classList.remove('active');
        document.body.style.overflow = '';
    }
    
    function toggleStartButton() {
        const accepted = document.getElementById('acceptTerms').checked;
        document.getElementById('startBtn').disabled = !accepted;
    }
    </script>
    
    <!-- Terms of Service Modal -->
    <div class="modal-overlay" id="tosModal" onclick="if(event.target===this)closeModal('tosModal')">
        <div class="modal">
            <h2>üìú Terms of Service</h2>
            
            <h3>1. Dienst Beschrijving</h3>
            <p>SnapMemories Downloader ("de Tool") is een client-side webapplicatie die gebruikers helpt hun Snapchat Memories te downloaden via offici√´le GDPR data exports. De Tool wordt aangeboden door Phiosk Development.</p>
            
            <h3>2. Geen Affiliatie</h3>
            <p><strong>Deze Tool is NIET geaffilieerd met, goedgekeurd door, of verbonden aan Snap Inc. of Snapchat.</strong> Snapchat en gerelateerde merken zijn handelsmerken van Snap Inc.</p>
            
            <h3>3. Gebruik Op Eigen Risico</h3>
            <p>Door deze Tool te gebruiken, erkent u dat:</p>
            <ul>
                <li>U de Tool gebruikt op <strong>eigen risico en verantwoordelijkheid</strong></li>
                <li>U alleen uw <strong>eigen persoonlijke data</strong> downloadt waartoe u rechtmatig toegang heeft</li>
                <li>Phiosk Development niet verantwoordelijk is voor eventuele gevolgen van het gebruik</li>
                <li>De Tool "as is" wordt aangeboden zonder garanties</li>
            </ul>
            
            <h3>4. Beperking van Aansprakelijkheid</h3>
            <p>Phiosk Development is niet aansprakelijk voor:</p>
            <ul>
                <li>Schade voortvloeiend uit het gebruik van de Tool</li>
                <li>Verlies van data of toegang tot uw Snapchat account</li>
                <li>Schending van Snapchat's Terms of Service door de gebruiker</li>
                <li>Technische storingen of onbeschikbaarheid</li>
            </ul>
            
            <h3>5. Correcte Gebruik</h3>
            <p>U stemt ermee in de Tool alleen te gebruiken voor het downloaden van uw eigen, persoonlijke Snapchat Memories die u via de offici√´le GDPR data export heeft verkregen.</p>
            
            <h3>6. Wijzigingen</h3>
            <p>We behouden het recht deze voorwaarden te wijzigen. Voortgezet gebruik na wijzigingen betekent acceptatie van de nieuwe voorwaarden.</p>
            
            <p style="margin-top:20px;font-size:11px;opacity:0.7">Laatst bijgewerkt: Januari 2026</p>
            
            <button class="btn btn-primary modal-close" onclick="closeModal('tosModal')">Sluiten</button>
        </div>
    </div>
    
    <!-- Privacy Policy Modal -->
    <div class="modal-overlay" id="privacyModal" onclick="if(event.target===this)closeModal('privacyModal')">
        <div class="modal">
            <h2>üîí Privacy Policy</h2>
            
            <h3>1. Geen Data Verzameling</h3>
            <p><strong>Wij verzamelen, verwerken of bewaren GEEN persoonlijke gegevens.</strong> De Tool werkt 100% client-side in uw browser.</p>
            
            <h3>2. Hoe De Tool Werkt</h3>
            <p>Alle verwerking gebeurt lokaal:</p>
            <ul>
                <li>Uw HTML bestand wordt <strong>alleen in uw browser</strong> gelezen</li>
                <li>Downloads gaan <strong>direct van Snapchat naar uw apparaat</strong></li>
                <li>Wij zien of ontvangen uw bestanden, foto's of video's <strong>nooit</strong></li>
                <li>Geen data passeert onze servers</li>
            </ul>
            
            <h3>3. Cookies & Tracking</h3>
            <p>Wij gebruiken:</p>
            <ul>
                <li>‚ùå Geen cookies</li>
                <li>‚ùå Geen analytics (Google Analytics, etc.)</li>
                <li>‚ùå Geen tracking pixels</li>
                <li>‚ùå Geen fingerprinting</li>
            </ul>
            
            <h3>4. GDPR Compliance</h3>
            <p>Omdat wij geen persoonlijke data verzamelen of verwerken, zijn de meeste GDPR-vereisten niet van toepassing. Desondanks:</p>
            <ul>
                <li>De Tool helpt u uw GDPR-recht op data portabiliteit uit te oefenen</li>
                <li>Uw data blijft te allen tijde onder uw controle</li>
                <li>Er is geen data om te verwijderen, omdat we niets opslaan</li>
            </ul>
            
            <h3>5. Externe Verbindingen</h3>
            <p>De Tool maakt verbinding met:</p>
            <ul>
                <li><strong>Snapchat servers</strong> - om uw memories te downloaden (direct in uw browser)</li>
                <li><strong>Google Fonts</strong> - voor lettertypen (geen tracking)</li>
                <li><strong>CDN's</strong> - voor JavaScript bibliotheken (JSZip, FileSaver)</li>
            </ul>
            
            <h3>6. Contact</h3>
            <p>Voor vragen over deze Privacy Policy kunt u contact opnemen via <a href="https://development.phiosk.be" target="_blank">development.phiosk.be</a>.</p>
            
            <p style="margin-top:20px;font-size:11px;opacity:0.7">Laatst bijgewerkt: Januari 2026</p>
            
            <button class="btn btn-primary modal-close" onclick="closeModal('privacyModal')">Sluiten</button>
        </div>
    </div>
</body>
</html>
